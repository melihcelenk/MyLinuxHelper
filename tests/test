#!/usr/bin/env bash
# test - Main test runner for MyLinuxHelper
#
# Usage:
#   ./tests/test              # Run all tests
#   ./tests/test mlh-history  # Run specific test suite

set -euo pipefail

# Colors for output
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(dirname "$SCRIPT_DIR")"

# Test statistics (use temp file for cross-subshell communication)
STATS_FILE=$(mktemp)
echo "0 0 0 0" >"$STATS_FILE" # total passed failed skipped

# Suite statistics file (one line per suite: suite_name total passed failed skipped)
SUITE_STATS_FILE=$(mktemp)

# Cleanup stats files on exit
trap "rm -f '$STATS_FILE' '$SUITE_STATS_FILE'" EXIT

load_stats() {
	read -r TOTAL_TESTS PASSED_TESTS FAILED_TESTS SKIPPED_TESTS <"$STATS_FILE"
}

save_stats() {
	echo "$TOTAL_TESTS $PASSED_TESTS $FAILED_TESTS $SKIPPED_TESTS" >"$STATS_FILE"
}

print_header() {
	echo ""
	echo -e "${CYAN}========================================${NC}"
	echo -e "${CYAN}$1${NC}"
	echo -e "${CYAN}========================================${NC}"
	echo ""
}

print_test_result() {
	local test_name="$1"
	local result="$2"
	local message="${3:-}"

	# Load current stats from file
	load_stats

	TOTAL_TESTS=$((TOTAL_TESTS + 1))

	if [ "$result" = "PASS" ]; then
		PASSED_TESTS=$((PASSED_TESTS + 1))
		echo -e "${GREEN}✓ PASS${NC}: $test_name"
	elif [ "$result" = "SKIP" ]; then
		SKIPPED_TESTS=$((SKIPPED_TESTS + 1))
		echo -e "${YELLOW}⊘ SKIP${NC}: $test_name"
		if [ -n "$message" ]; then
			echo -e "  ${YELLOW}$message${NC}"
		fi
	elif [ "$result" = "NOT_FOUND" ]; then
		FAILED_TESTS=$((FAILED_TESTS + 1))
		echo -e "${YELLOW}⚠ NOT FOUND${NC}: $test_name"
		if [ -n "$message" ]; then
			echo -e "  ${YELLOW}$message${NC}"
		fi
	else
		FAILED_TESTS=$((FAILED_TESTS + 1))
		echo -e "${RED}✗ FAIL${NC}: $test_name"
		if [ -n "$message" ]; then
			echo -e "  ${YELLOW}$message${NC}"
		fi
	fi

	# Save updated stats to file
	save_stats
}

print_summary() {
	# Load final stats from file
	load_stats

	echo ""
	echo -e "${CYAN}========================================${NC}"
	echo -e "${CYAN}Test Summary${NC}"
	echo -e "${CYAN}========================================${NC}"
	
	# Print per-suite results if any suites were run
	if [ -s "$SUITE_STATS_FILE" ]; then
		echo ""
		echo -e "${CYAN}Results by Test Suite:${NC}"
		echo ""
		
		while IFS='|' read -r suite_name suite_total suite_passed suite_failed suite_skipped; do
			local status_indicator=""
			local color=""
			
			if [ "$suite_failed" -gt 0 ]; then
				status_indicator=" ${RED}[FAILURE]${NC}"
				color="$RED"
			else
				status_indicator=" ${GREEN}[OK]${NC}"
				color="$GREEN"
			fi
			
			# Print suite results with proper formatting
			printf "  %-25s" "$suite_name:"
			if [ "$suite_failed" -gt 0 ]; then
				echo -e "${RED}$suite_passed/$suite_total passed${NC}$status_indicator"
			else
				echo -e "${GREEN}$suite_passed/$suite_total passed${NC}$status_indicator"
			fi
		done < "$SUITE_STATS_FILE"
		
		echo ""
	fi
	
	echo -e "${CYAN}Overall Results:${NC}"
	echo -e "Total tests:  $TOTAL_TESTS"
	echo -e "${GREEN}Passed:       $PASSED_TESTS${NC}"
	if [ "$SKIPPED_TESTS" -gt 0 ]; then
		echo -e "${YELLOW}Skipped:      $SKIPPED_TESTS${NC}"
	fi
	if [ "$FAILED_TESTS" -gt 0 ]; then
		echo -e "${RED}Failed:       $FAILED_TESTS${NC}"
	else
		echo -e "Failed:       $FAILED_TESTS"
	fi
	echo ""

	if [ "$FAILED_TESTS" -eq 0 ]; then
		echo -e "${GREEN}All tests passed!${NC}"
		return 0
	else
		echo -e "${RED}TEST FAILURE${NC}"
		return 1
	fi
}

run_test_suite() {
	local suite_name="$1"
	local test_file="$SCRIPT_DIR/test-${suite_name}.sh"

	if [ ! -f "$test_file" ]; then
		print_test_result "Test suite '$suite_name'" "NOT_FOUND" "Test file not found: $test_file"
		return 0
	fi

	print_header "Running test suite: $suite_name"

	# PRE-CHECK: Validate syntax before running
	if ! bash -n "$test_file" 2>/dev/null; then
		echo -e "${RED}✗ SYNTAX ERROR${NC}: Test suite has invalid bash syntax"
		echo -e "${YELLOW}Likely cause: Windows line endings (CRLF)${NC}"
		echo -e "${YELLOW}Fix with: sed -i 's/\\r\$//' $test_file${NC}"
		FAILED_TESTS=$((FAILED_TESTS + 1))
		TOTAL_TESTS=$((TOTAL_TESTS + 1))
		return 0 # Don't exit, just mark as failed and continue
	fi

	# Save stats before running suite to calculate delta
	load_stats
	local suite_start_total=$TOTAL_TESTS
	local suite_start_passed=$PASSED_TESTS
	local suite_start_failed=$FAILED_TESTS
	local suite_start_skipped=$SKIPPED_TESTS

	# Run test file in a subshell to isolate exit/trap statements
	# We use ( ) subshell syntax to prevent 'exit' from killing the test runner
	# Export necessary variables and functions for subshell
	export -f print_test_result load_stats save_stats print_header
	export STATS_FILE ROOT_DIR GREEN RED YELLOW CYAN NC

	(
		# Source the test file which will call print_test_result for each test
		# shellcheck source=/dev/null
		source "$test_file"
	)

	# Calculate delta for this suite
	load_stats
	local suite_total=$((TOTAL_TESTS - suite_start_total))
	local suite_passed=$((PASSED_TESTS - suite_start_passed))
	local suite_failed=$((FAILED_TESTS - suite_start_failed))
	local suite_skipped=$((SKIPPED_TESTS - suite_start_skipped))

	# Save suite stats (pipe-delimited for easy parsing)
	echo "${suite_name}|${suite_total}|${suite_passed}|${suite_failed}|${suite_skipped}" >> "$SUITE_STATS_FILE"
}

run_all_tests() {
	print_header "MyLinuxHelper - Test Suite"

	# Find all test-*.sh files in tests directory
	local test_files
	test_files=$(find "$SCRIPT_DIR" -maxdepth 1 -name "test-*.sh" -type f | sort)

	if [ -z "$test_files" ]; then
		echo -e "${YELLOW}No test files found in $SCRIPT_DIR${NC}"
		return 1
	fi

	# Run each test suite
	while IFS= read -r test_file; do
		local suite_name
		suite_name=$(basename "$test_file" .sh)
		suite_name="${suite_name#test-}"

		run_test_suite "$suite_name"
	done <<<"$test_files"
}

main() {
	cd "$ROOT_DIR"

	if [ $# -eq 0 ]; then
		# Run all tests
		run_all_tests
	else
		# Run specific test suite
		run_test_suite "$1"
	fi

	print_summary
}

main "$@"
